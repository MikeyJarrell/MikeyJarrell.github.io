[{"name":"app.R","content":"# =============================================================================\n# PBA Scoring Dashboard\n# =============================================================================\n#\n# Interactive dashboard for exploring plant scores with adjustable weights.\n#\n# =============================================================================\n\nlibrary(shiny)\nlibrary(dplyr)\nlibrary(DT)\n\n# -----------------------------------------------------------------------------\n# Load Data\n# -----------------------------------------------------------------------------\n\n# Load anonymized data (for both local and deployment)\nscores_raw <- read.csv(\"plant_scores.csv\", stringsAsFactors = FALSE)\n\n# -----------------------------------------------------------------------------\n# Default Parameters (from score_plants.R)\n# -----------------------------------------------------------------------------\n\ndefaults <- list(\n  # Pathway weights (must sum to 1)\n  pathway_stack = 60,\n  pathway_slag = 18,\n  pathway_acid = 10,\n  pathway_fugitive = 12,\n\n  # Measurement source weights (must sum to 1)\n  meas_air = 50,\n  meas_soil = 25,\n  meas_blood = 25,\n\n  # Assessment vs. measurement weight (0 = pure assessment, 100 = pure measurement)\n  assess_vs_meas = 33,  # Default ~33% measurement matches current 67/33 split\n\n  # Discount rate for population (delta per 100m)\n  delta = 0.99,\n\n  # Rate vs Total weight (0 = pure rate, 100 = pure total)\n  rate_vs_total = 0,\n\n  # Number of tiers\n  num_tiers = 4,\n\n  # Tier thresholds (4-tier system default)\n  tier_thresholds = c(20, 50, 80),  # Certified: 0-20, Conditional: 21-50, Remediation: 51-80, Excluded: 81+\n\n  # Reference values\n  throughput_ref = 5000,\n  cpBLL_per_harm = 8500\n)\n\n# -----------------------------------------------------------------------------\n# Helper Functions\n# -----------------------------------------------------------------------------\n\n# Generate tier names based on number of tiers\nget_tier_names <- function(n) {\n  if (n == 2) {\n    return(c(\"Certified\", \"Excluded\"))\n  } else if (n == 3) {\n    return(c(\"Certified\", \"Conditional\", \"Excluded\"))\n  } else if (n == 4) {\n    return(c(\"Certified\", \"Conditional\", \"Remediation\", \"Excluded\"))\n  } else {\n    # For 5+ tiers: Certified, Tier 2, Tier 3, ..., Excluded\n    middle <- paste0(\"Tier \", 2:(n-1))\n    return(c(\"Certified\", middle, \"Excluded\"))\n  }\n}\n\n# Generate colorblind-safe gradient colors (blue to orange)\n# Blue (#2166AC) = best (low harm) to Orange (#D95F02) = worst (high harm)\nget_tier_colors <- function(n) {\n  # Define gradient endpoints and midpoint for smooth transition\n  # Using a blue-orange diverging palette (colorblind safe)\n  blue <- c(33, 102, 172)     # #2166AC\n  light_blue <- c(103, 169, 207)  # #67A9CF\n  neutral <- c(247, 247, 247)     # #F7F7F7\n  light_orange <- c(253, 174, 97) # #FDAE61\n  orange <- c(217, 95, 2)     # #D95F02\n\n  if (n == 1) {\n    return(\"#2166AC\")\n  }\n\n  # Generate n evenly-spaced colors along the gradient\n  positions <- seq(0, 1, length.out = n)\n\n  colors <- sapply(positions, function(p) {\n    # 5-point gradient: blue -> light_blue -> neutral -> light_orange -> orange\n    if (p <= 0.25) {\n      # Blue to light blue\n      t <- p / 0.25\n      rgb_val <- blue + t * (light_blue - blue)\n    } else if (p <= 0.5) {\n      # Light blue to neutral\n      t <- (p - 0.25) / 0.25\n      rgb_val <- light_blue + t * (neutral - light_blue)\n    } else if (p <= 0.75) {\n      # Neutral to light orange\n      t <- (p - 0.5) / 0.25\n      rgb_val <- neutral + t * (light_orange - neutral)\n    } else {\n      # Light orange to orange\n      t <- (p - 0.75) / 0.25\n      rgb_val <- light_orange + t * (orange - light_orange)\n    }\n    sprintf(\"#%02X%02X%02X\", round(rgb_val[1]), round(rgb_val[2]), round(rgb_val[3]))\n  })\n\n  return(colors)\n}\n\n# Determine text color (black or white) for readability on background\nget_text_color <- function(hex_color) {\n  # Convert hex to RGB\n  r <- strtoi(substr(hex_color, 2, 3), 16)\n  g <- strtoi(substr(hex_color, 4, 5), 16)\n  b <- strtoi(substr(hex_color, 6, 7), 16)\n\n  # Calculate luminance\n  luminance <- (0.299 * r + 0.587 * g + 0.114 * b) / 255\n\n  # Return white for dark backgrounds, black for light\n  if (luminance > 0.5) \"black\" else \"white\"\n}\n\n# Generate default thresholds for n tiers\nget_default_thresholds <- function(n) {\n  if (n <= 1) return(numeric(0))\n  # Space thresholds evenly between 0 and 100\n  # For 4 tiers: 20, 50, 80 (our current defaults)\n  if (n == 4) {\n    return(c(20, 50, 80))\n  }\n  # For other tier counts, space evenly\n  seq(100 / n, 100 * (n - 1) / n, length.out = n - 1)\n}\n\n# -----------------------------------------------------------------------------\n# UI\n# -----------------------------------------------------------------------------\n\nui <- fluidPage(\n\n  # Custom CSS for tier colors and styling\n  tags$head(\n    tags$style(HTML(\"\n      .slider-group { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }\n      .slider-group h4 { margin-top: 0; color: #495057; }\n      .weight-display { font-family: monospace; font-size: 12px; color: #6c757d; margin-top: 5px; }\n      h2 { color: #212529; border-bottom: 2px solid #007bff; padding-bottom: 10px; }\n      .main-score { font-size: 18px; font-weight: bold; }\n      .tier-legend { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }\n      .tier-legend-item { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }\n    \"))\n  ),\n\n  titlePanel(\"PBA Plant Scoring Dashboard\"),\n\n  sidebarLayout(\n    sidebarPanel(\n      width = 3,\n\n      # Tier configuration\n      div(class = \"slider-group\",\n        h4(\"Tier Configuration\"),\n        p(\"How many tiers should we use for classification?\", style = \"font-size: 12px; color: #6c757d;\"),\n        selectInput(\"num_tiers\", \"Number of Tiers\",\n                    choices = 2:6,\n                    selected = defaults$num_tiers),\n        uiOutput(\"tier_thresholds_ui\"),\n        uiOutput(\"tier_legend\")\n      ),\n\n      # Assessment vs. Measurement weight\n      div(class = \"slider-group\",\n        h4(\"Assessment vs. Measurement\"),\n        p(\"Should we trust visual assessments or pollution measurements more?\", style = \"font-size: 12px; color: #6c757d;\"),\n        sliderInput(\"assess_meas\", \"Weight toward Measurements\",\n                    min = 0, max = 100, value = defaults$assess_vs_meas, step = 5),\n        p(\"0 = Pure assessment (checklist only)\", style = \"font-size: 11px; color: #6c757d;\"),\n        p(\"100 = Pure measurements (air/soil/blood)\", style = \"font-size: 11px; color: #6c757d;\")\n      ),\n\n      # Pathway weights\n      div(class = \"slider-group\",\n        h4(\"Pathway Weights\"),\n        p(\"Which emission pathways matter most?\", style = \"font-size: 12px; color: #6c757d;\"),\n        sliderInput(\"w_stack\", \"Stack\", min = 0, max = 100, value = defaults$pathway_stack, step = 1),\n        sliderInput(\"w_slag\", \"Slag\", min = 0, max = 100, value = defaults$pathway_slag, step = 1),\n        sliderInput(\"w_acid\", \"Acid\", min = 0, max = 100, value = defaults$pathway_acid, step = 1),\n        sliderInput(\"w_fugitive\", \"Fugitive\", min = 0, max = 100, value = defaults$pathway_fugitive, step = 1)\n      ),\n\n      # Measurement source weights\n      div(class = \"slider-group\",\n        h4(\"Measurement Weights\"),\n        p(\"Which measurement types should we trust most?\", style = \"font-size: 12px; color: #6c757d;\"),\n        sliderInput(\"w_air\", \"Air (current)\", min = 0, max = 100, value = defaults$meas_air, step = 1),\n        sliderInput(\"w_soil\", \"Soil (historical)\", min = 0, max = 100, value = defaults$meas_soil, step = 1),\n        sliderInput(\"w_blood\", \"Blood (direct)\", min = 0, max = 100, value = defaults$meas_blood, step = 1)\n      ),\n\n      # Population discounting\n      div(class = \"slider-group\",\n        h4(\"Population Discounting\"),\n        p(\"Should plants in remote areas be scored the same as those in dense cities?\", style = \"font-size: 12px; color: #6c757d;\"),\n        sliderInput(\"delta\", \"Delta (per 100m)\", min = 0.90, max = 1.00, value = defaults$delta, step = 0.01),\n        p(\"1.0 = all population counts equally\", style = \"font-size: 11px; color: #6c757d;\"),\n        p(\"0.9 = distant population discounted heavily\", style = \"font-size: 11px; color: #6c757d;\")\n      ),\n\n      # Rate vs Total\n      div(class = \"slider-group\",\n        h4(\"Rate vs. Total\"),\n        p(\"Should we score on harm per battery (rate) or current damage (total)?\", style = \"font-size: 12px; color: #6c757d;\"),\n        sliderInput(\"rate_total\", \"Weight toward Total\", min = 0, max = 100, value = defaults$rate_vs_total, step = 5),\n        p(\"0 = Pure rate (harm per battery)\", style = \"font-size: 11px; color: #6c757d;\"),\n        p(\"100 = Pure total (current damage)\", style = \"font-size: 11px; color: #6c757d;\")\n      ),\n\n      # Reset button\n      actionButton(\"reset\", \"Reset to Defaults\", class = \"btn-secondary btn-sm\")\n    ),\n\n    mainPanel(\n      width = 9,\n\n      h2(\"Plant Rankings\"),\n      p(\"Ranked from best (lowest score) to worst. Tier based on final score.\"),\n\n      DTOutput(\"scores_table\"),\n\n      br(),\n\n      h2(\"Column Definitions\"),\n\n      h4(\"Core\"),\n      tags$table(class = \"table table-striped table-sm\",\n        tags$tbody(\n          tags$tr(tags$td(tags$b(\"Score\"), style = \"width: 15%;\"), tags$td(\"Primary score used for tiering. Blends harm rate and total based on slider. Lower = better.\")),\n          tags$tr(tags$td(tags$b(\"Tier\")), tags$td(\"Classification based on score thresholds. Configurable from 2 to 6 tiers.\")),\n          tags$tr(tags$td(tags$b(\"Pop\")), tags$td(\"Population density factor. 1.0 = sparsest area; higher = more people nearby = more harm.\")),\n          tags$tr(tags$td(tags$b(\"Throughput\")), tags$td(\"Tons of batteries processed per year.\"))\n        )\n      ),\n\n      h4(\"Pathways\", style = \"margin-top: 15px;\"),\n      p(\"Higher = more emissions from that pathway = worse.\", style = \"font-size: 13px; color: #6c757d; margin-bottom: 5px;\"),\n      tags$table(class = \"table table-striped table-sm\",\n        tags$tbody(\n          tags$tr(tags$td(tags$b(\"Stack\"), style = \"width: 15%;\"), tags$td(\"Emissions from furnace exhaust. Low = good baghouse, scrubber, clear exhaust.\")),\n          tags$tr(tags$td(tags$b(\"Slag\")), tags$td(\"Emissions from waste. Low = proper containment, no visible slag, good furnace.\")),\n          tags$tr(tags$td(tags$b(\"Acid\")), tags$td(\"Emissions from electrolyte. Low = hammermill, neutralization, responsible supply chain.\")),\n          tags$tr(tags$td(tags$b(\"Fug\")), tags$td(\"Fugitive dust escaping. Low = enclosed building, negative pressure, good LEV.\"))\n        )\n      ),\n\n      h4(\"Measurements\", style = \"margin-top: 15px;\"),\n      p(\"Higher = more lead detected = worse.\", style = \"font-size: 13px; color: #6c757d; margin-bottom: 5px;\"),\n      tags$table(class = \"table table-striped table-sm\",\n        tags$tbody(\n          tags$tr(tags$td(tags$b(\"Air\"), style = \"width: 15%;\"), tags$td(\"Lead in air samples. Reflects current emissions.\")),\n          tags$tr(tags$td(tags$b(\"Soil\")), tags$td(\"Lead in soil samples. Reflects historical/cumulative emissions.\")),\n          tags$tr(tags$td(tags$b(\"Blood\")), tags$td(\"Lead in blood samples. Direct measure of human exposure.\"))\n        )\n      ),\n\n      h4(\"Harm\", style = \"margin-top: 15px;\"),\n      p(\"Higher = more harm = worse.\", style = \"font-size: 13px; color: #6c757d; margin-bottom: 5px;\"),\n      tags$table(class = \"table table-striped table-sm\",\n        tags$tbody(\n          tags$tr(tags$td(tags$b(\"Rate\"), style = \"width: 15%;\"), tags$td(\"Harm per battery. Answers: 'should batteries go here?'\")),\n          tags$tr(tags$td(tags$b(\"Total\")), tags$td(\"Current total harm (rate x throughput). Answers: 'how much damage now?'\"))\n        )\n      ),\n\n      h4(\"PV(cpBLL)\", style = \"margin-top: 15px;\"),\n      p(\"Present value of cumulative person-BLL. Actual harm in physical units.\", style = \"font-size: 13px; color: #6c757d; margin-bottom: 5px;\"),\n      tags$table(class = \"table table-striped table-sm\",\n        tags$tbody(\n          tags$tr(tags$td(tags$b(\"Rate\"), style = \"width: 15%;\"), tags$td(\"Person-ug/dL of blood lead per ton of batteries processed.\")),\n          tags$tr(tags$td(tags$b(\"Total\")), tags$td(\"Total person-ug/dL caused by plant's current operations.\"))\n        )\n      ),\n\n      br(),\n\n      h2(\"Understanding the Sliders\"),\n\n      h4(\"Tier Configuration\"),\n      p(\"Choose how many tiers to use for classifying plants (2-6). More tiers provide finer distinctions; fewer tiers simplify decisions. \",\n        \"The color gradient runs from blue (best) to orange (worst) and is designed to be colorblind-friendly. \",\n        tags$b(\"Default:\"), \" 4 tiers (Certified, Conditional, Remediation, Excluded) with thresholds at 20, 50, and 80.\"),\n\n      h4(\"Assessment vs. Measurement\"),\n      p(\"This slider controls how much weight to give \",\n        tags$b(\"visual assessments\"), \" (checklist observations) vs. \",\n        tags$b(\"pollution measurements\"), \" (air, soil, blood lead data). \",\n        \"At 0%, only assessment data matters. At 100%, only measurements matter. \",\n        \"Increase measurement weight if you trust environmental data more than visual inspections. \",\n        tags$b(\"Default:\"), \" 33% measurement (assessment 67% | measurement 33%).\"),\n\n      h4(\"Pathway Weights\"),\n      p(\"Lead emissions come from four pathways: stack (furnace exhaust), slag (waste disposal), acid (battery electrolyte), and fugitive (dust escaping the building). \",\n        \"Weights reflect each pathway's share of maximum potential emissions. Stack dominates because uncontrolled furnaces emit the most lead. \",\n        \"Adjust these if you believe certain pathways matter more or less than our defaults suggest. \",\n        tags$b(\"Default:\"), \" Stack 60 | Slag 18 | Acid 10 | Fugitive 12.\"),\n\n      h4(\"Measurement Weights\"),\n      p(\"We estimate emissions from three data sources. \",\n        tags$b(\"Air\"), \" captures current operations — what's happening right now. \",\n        tags$b(\"Soil\"), \" captures historical emissions — cumulative over years. \",\n        tags$b(\"Blood\"), \" directly measures human exposure — the outcome we ultimately care about. \",\n        \"If you trust blood measurements as ground truth, increase its weight. If you think historical practices matter, increase soil. \",\n        tags$b(\"Default:\"), \" Air 50 | Soil 25 | Blood 25.\"),\n\n      h4(\"Population Discounting (Delta)\"),\n      p(\"Delta controls how much we weight nearby vs. distant population. \",\n        \"At delta = 1.0, all population counts equally regardless of distance — only total nearby population matters. \",\n        \"At delta = 0.90, distant population is heavily discounted — plants in sparse areas get lower scores. \",\n        \"This is a value judgment: do emissions matter if no one is nearby to absorb them? \",\n        tags$b(\"Default:\"), \" 0.99.\"),\n\n      h4(\"Rate vs. Total\"),\n      p(\"This is perhaps the most important conceptual choice. \",\n        tags$b(\"Rate\"), \" (harm per battery) answers: 'If we had a battery to recycle, should we send it here?' \",\n        tags$b(\"Total\"), \" (current damage) answers: 'How much harm is this plant causing right now?' \",\n        \"We default to rate because shutting down a high-throughput, low-rate plant could push batteries to worse alternatives. \",\n        \"But if your goal is to identify the biggest current problems, weight toward total. \",\n        tags$b(\"Default:\"), \" 0 (pure rate).\")\n    )\n  )\n)\n\n# -----------------------------------------------------------------------------\n# Server\n# -----------------------------------------------------------------------------\n\nserver <- function(input, output, session) {\n\n  # Reactive: current tier configuration\n  tier_config <- reactive({\n    n <- as.integer(input$num_tiers)\n    list(\n      n = n,\n      names = get_tier_names(n),\n      colors = get_tier_colors(n),\n      text_colors = sapply(get_tier_colors(n), get_text_color)\n    )\n  })\n\n  # Reactive: current thresholds (from dynamic UI)\n  current_thresholds <- reactive({\n    n <- as.integer(input$num_tiers)\n    if (n <= 1) return(numeric(0))\n\n    # Get default thresholds for this tier count\n    default_thresh <- get_default_thresholds(n)\n\n    # Get threshold values from dynamic inputs (fall back to defaults)\n    thresholds <- sapply(1:(n-1), function(i) {\n      val <- input[[paste0(\"thresh_\", i)]]\n      if (is.null(val)) default_thresh[i] else val\n    })\n\n    # Ensure thresholds are sorted and unique\n    thresholds <- sort(unique(thresholds))\n\n    # If we lost some thresholds due to duplicates, fill in with defaults\n    if (length(thresholds) < n - 1) {\n      thresholds <- default_thresh\n    }\n\n    thresholds\n  })\n\n  # Dynamic UI for tier thresholds\n  output$tier_thresholds_ui <- renderUI({\n    n <- as.integer(input$num_tiers)\n    if (n <= 1) return(NULL)\n\n    names <- get_tier_names(n)\n    defaults <- get_default_thresholds(n)\n\n    # Create n-1 threshold sliders\n    slider_list <- lapply(1:(n-1), function(i) {\n      sliderInput(\n        paste0(\"thresh_\", i),\n        label = paste0(names[i], \" max\"),\n        min = 0, max = 150, value = defaults[i], step = 5\n      )\n    })\n\n    # Add description\n    tagList(\n      p(paste0(\"Above \", names[n-1], \" max = \", names[n]), style = \"font-size: 11px; color: #6c757d;\"),\n      slider_list\n    )\n  })\n\n  # Tier legend showing colors\n  output$tier_legend <- renderUI({\n    tc <- tier_config()\n    items <- mapply(function(name, color, text_color) {\n      tags$span(class = \"tier-legend-item\",\n                style = sprintf(\"background-color: %s; color: %s;\", color, text_color),\n                name)\n    }, tc$names, tc$colors, tc$text_colors, SIMPLIFY = FALSE)\n\n    div(class = \"tier-legend\", items)\n  })\n\n  # Reset to defaults\n  observeEvent(input$reset, {\n    updateSelectInput(session, \"num_tiers\", selected = defaults$num_tiers)\n    updateSliderInput(session, \"assess_meas\", value = defaults$assess_vs_meas)\n    updateSliderInput(session, \"w_stack\", value = defaults$pathway_stack)\n    updateSliderInput(session, \"w_slag\", value = defaults$pathway_slag)\n    updateSliderInput(session, \"w_acid\", value = defaults$pathway_acid)\n    updateSliderInput(session, \"w_fugitive\", value = defaults$pathway_fugitive)\n    updateSliderInput(session, \"w_air\", value = defaults$meas_air)\n    updateSliderInput(session, \"w_soil\", value = defaults$meas_soil)\n    updateSliderInput(session, \"w_blood\", value = defaults$meas_blood)\n    updateSliderInput(session, \"delta\", value = defaults$delta)\n    updateSliderInput(session, \"rate_total\", value = defaults$rate_vs_total)\n\n    # Reset threshold sliders\n    default_thresh <- get_default_thresholds(defaults$num_tiers)\n    for (i in seq_along(default_thresh)) {\n      updateSliderInput(session, paste0(\"thresh_\", i), value = default_thresh[i])\n    }\n  })\n\n  # Normalized pathway weights\n  pathway_weights <- reactive({\n    raw <- c(input$w_stack, input$w_slag, input$w_acid, input$w_fugitive)\n    total <- sum(raw)\n    if (total == 0) return(c(0.25, 0.25, 0.25, 0.25))\n    raw / total\n  })\n\n  # Normalized measurement weights\n  meas_weights <- reactive({\n    raw <- c(input$w_air, input$w_soil, input$w_blood)\n    total <- sum(raw)\n    if (total == 0) return(c(0.33, 0.33, 0.34))\n    raw / total\n  })\n\n  # Recalculate scores based on current slider values\n  scores_adjusted <- reactive({\n    pw <- pathway_weights()\n    mw <- meas_weights()\n    assess_meas_weight <- input$assess_meas / 100  # 0 = pure assessment, 1 = pure measurement\n\n    # Get tier configuration\n    tc <- tier_config()\n    thresholds <- current_thresholds()\n\n    # CSV now stores HARM points directly (higher = more deficiencies = worse)\n    # Apply weight adjustments to scale harm by pathway importance\n    result <- scores_raw %>%\n      mutate(\n        # Separate assessment and measurement harm\n        # Assessment harm (from checklist)\n        total_assessment_harm = stack_assessment_harm + fugitive_assessment_harm + slag_harm + acid_harm,\n\n        # Measurement harm with adjusted weights (air/soil/blood)\n        stack_meas_harm_adj = (stack_air_harm * mw[1] / 0.50) +\n                              (stack_soil_harm * mw[2] / 0.25) +\n                              (stack_blood_harm * mw[3] / 0.25),\n        fugitive_meas_harm_adj = (fugitive_air_harm * mw[1] / 0.50) +\n                                 (fugitive_soil_harm * mw[2] / 0.25) +\n                                 (fugitive_blood_harm * mw[3] / 0.25),\n        total_measurement_harm = stack_meas_harm_adj + fugitive_meas_harm_adj,\n\n        # Blend assessment and measurement harm based on slider\n        # When assess_meas_weight = 0: pure assessment\n        # When assess_meas_weight = 1: pure measurement\n        # Scale so that at default (0.33), the total harm equals the sum of both\n        blended_stack_harm = stack_assessment_harm * (1 - assess_meas_weight) + stack_meas_harm_adj * assess_meas_weight,\n        blended_fugitive_harm = fugitive_assessment_harm * (1 - assess_meas_weight) + fugitive_meas_harm_adj * assess_meas_weight,\n        # Slag and acid are assessment-only (no measurement component)\n        blended_slag_harm = slag_harm * (1 - assess_meas_weight),\n        blended_acid_harm = acid_harm * (1 - assess_meas_weight),\n\n        # Apply pathway weight adjustments\n        stack_harm_adj = blended_stack_harm * (pw[1] / 0.60),\n        slag_harm_adj = blended_slag_harm * (pw[2] / 0.18),\n        acid_harm_adj = blended_acid_harm * (pw[3] / 0.10),\n        fugitive_harm_adj = blended_fugitive_harm * (pw[4] / 0.12),\n\n        # Measurement harm for display (sum across sources)\n        air_harm_display = stack_air_harm + fugitive_air_harm,\n        soil_harm_display = stack_soil_harm + fugitive_soil_harm,\n        blood_harm_display = stack_blood_harm + fugitive_blood_harm,\n\n        # Raw harm = sum of pathway harms\n        raw_harm_adj = stack_harm_adj + slag_harm_adj + acid_harm_adj + fugitive_harm_adj,\n\n        # L_i adjustment for delta\n        # This is approximate - would need full recalc with raster for accuracy\n        # For now, scale L_i based on delta change\n        # Higher delta = less discounting = L_i closer to 1\n        delta_ratio = log(input$delta) / log(defaults$delta),\n        L_i_adj = 1 + (L_i - 1) * delta_ratio,\n        L_i_adj = pmax(1, L_i_adj),\n\n        # Harm rate and total\n        harm_rate_adj = L_i_adj * raw_harm_adj,\n        harm_total_adj = harm_rate_adj * throughput_tons_yr / defaults$throughput_ref,\n\n        # Blend rate and total based on slider\n        rate_weight = 1 - input$rate_total / 100,\n        final_score = rate_weight * harm_rate_adj + (1 - rate_weight) * harm_total_adj,\n\n        # cpBLL: total = harm_total * k, rate = total / throughput\n        cpBLL_total_adj = harm_total_adj * defaults$cpBLL_per_harm,\n        cpBLL_rate_adj = cpBLL_total_adj / throughput_tons_yr\n      )\n\n    # Assign tiers based on dynamic thresholds\n    result <- result %>%\n      mutate(\n        tier_adj = {\n          # Create tier assignment based on thresholds\n          tier_idx <- cut(final_score,\n                          breaks = c(-Inf, thresholds, Inf),\n                          labels = FALSE,\n                          right = TRUE)\n          tc$names[tier_idx]\n        }\n      ) %>%\n      arrange(final_score) %>%\n      mutate(rank = row_number())\n\n    result\n  })\n\n  # Render the scores table\n  output$scores_table <- renderDT({\n    tc <- tier_config()\n\n    df <- scores_adjusted() %>%\n      select(\n        Rank = rank,\n        Plant = plant_name,\n        Tier = tier_adj,\n        Score = final_score,\n        # Pathways (HARM - higher = more deficiencies = worse)\n        Stack = stack_harm_adj,\n        Slag = slag_harm_adj,\n        Acid = acid_harm_adj,\n        Fug = fugitive_harm_adj,\n        # Measurements (HARM - higher = more lead detected = worse)\n        Air = air_harm_display,\n        Soil = soil_harm_display,\n        Blood = blood_harm_display,\n        # Location\n        Pop = L_i_adj,\n        # Throughput (moved here, between Pop and Harm)\n        Throughput = throughput_tons_yr,\n        # Final metrics\n        Rate = harm_rate_adj,\n        Total = harm_total_adj,\n        `cpBLL Rate` = cpBLL_rate_adj,\n        `cpBLL Total` = cpBLL_total_adj\n      ) %>%\n      mutate(\n        across(where(is.numeric) & !matches(\"Rank|Throughput|cpBLL\"), ~round(.x, 1)),\n        across(matches(\"cpBLL\"), ~format(round(.x, 0), big.mark = \",\")),\n        Throughput = format(Throughput, big.mark = \",\")\n      )\n\n    # Create container with grouped headers\n    sketch <- htmltools::withTags(table(\n      class = 'display',\n      thead(\n        tr(\n          th(rowspan = 2, '', style = 'text-align: center;'),\n          th(rowspan = 2, 'Plant', style = 'text-align: center;'),\n          th(rowspan = 2, 'Tier', style = 'text-align: center;'),\n          th(rowspan = 2, 'Score', style = 'text-align: center;'),\n          th(colspan = 4, 'Pathways', style = 'text-align: center; border-bottom: 2px solid #dee2e6;'),\n          th(colspan = 3, 'Measurements', style = 'text-align: center; border-bottom: 2px solid #dee2e6;'),\n          th(rowspan = 2, 'Pop', style = 'text-align: center;'),\n          th(rowspan = 2, 'Thru', style = 'text-align: center;'),\n          th(colspan = 2, 'Harm', style = 'text-align: center; border-bottom: 2px solid #dee2e6;'),\n          th(colspan = 2, 'PV(cpBLL)', style = 'text-align: center; border-bottom: 2px solid #dee2e6;')\n        ),\n        tr(\n          th('Stack', style = 'text-align: center;'),\n          th('Slag', style = 'text-align: center;'),\n          th('Acid', style = 'text-align: center;'),\n          th('Fug', style = 'text-align: center;'),\n          th('Air', style = 'text-align: center;'),\n          th('Soil', style = 'text-align: center;'),\n          th('Blood', style = 'text-align: center;'),\n          th('Rate', style = 'text-align: center;'),\n          th('Total', style = 'text-align: center;'),\n          th('Rate', style = 'text-align: center;'),\n          th('Total', style = 'text-align: center;')\n        )\n      )\n    ))\n\n    datatable(\n      df,\n      container = sketch,\n      options = list(\n        pageLength = 20,\n        dom = 't',  # Just the table, no search/pagination\n        ordering = FALSE,\n        columnDefs = list(\n          list(className = 'dt-center', targets = '_all'),\n          list(className = 'main-score', targets = 3)  # Score column\n        )\n      ),\n      rownames = FALSE,\n      class = 'cell-border stripe hover'\n    ) %>%\n      formatStyle(\n        'Tier',\n        backgroundColor = styleEqual(tc$names, tc$colors),\n        color = styleEqual(tc$names, tc$text_colors),\n        fontWeight = 'bold'\n      ) %>%\n      formatStyle(\n        'Score',\n        fontWeight = 'bold',\n        fontSize = '14px'\n      )\n  })\n}\n\n# -----------------------------------------------------------------------------\n# Run App\n# -----------------------------------------------------------------------------\n\nshinyApp(ui = ui, server = server)\n","type":"text"},{"name":"plant_scores.csv","content":"plant_id,plant_name,lat,lon,throughput_tons_yr,stack_assessment_harm,slag_harm,acid_harm,fugitive_assessment_harm,stack_air_harm,fugitive_air_harm,stack_soil_harm,fugitive_soil_harm,stack_blood_harm,fugitive_blood_harm,stack_measurement_harm,fugitive_measurement_harm,D0_stack_air,D0_fugitive_air,D0_stack_soil,D0_fugitive_soil,observed_cpbll,stack_total_harm,slag_total_harm,acid_total_harm,fugitive_total_harm,raw_harm,discounted_pop,L_i,harm_rate,harm_total,cpBLL_rate,cpBLL_total,tier\nPLT01,Alpha Recycling Corp,-4.7124,25.5514,7331,30,6,6.6,2,0,0.7047863697534059,15,0,3.9450000000000003,0.1445,18.945,0.8492863697534059,0,137.7810367109925,2348.703404922456,0,526,48.945,6,6.6,2.8492863697534059,64.3942863697534,1107262.403209749,2.185138091526478,140.7,206.2,1195950,1752700,Excluded\nPLT02,Beta Metal Works,-4.2117000000000004,25.4566,6385,24,8,3.4,7,0,0.5220933625055536,15,0,3.37425,0.087425,18.37425,0.6095183625055536,0,88.89509652261229,1720.1442877529378,0,449.9,42.37425,8,3.4,7.6095183625055536,61.38376836250555,950472.561374196,1.8757196061104449,115.2,147.0,979200,1249500,Excluded\nPLT03,Gamma Industries Ltd,-4.591,25.9568,3944,22,4,7.2,2,1.147913810136124,0.1891597213119445,15,0.75,2.94825,0.044825,19.09616381013612,0.9839847213119445,30.18248044784582,19.894558422781557,584.3957645600183,1848.5555004005316,393.1,41.09616381013612,4,7.2,2.9839847213119445,55.28014853144807,710900.8900854411,1.4029344893520344,77.6,61.2,659600,520200,Remediation\nPLT04,Delta Smelting Co,-4.117,25.4533,5204,6,6,2.1,3,0.323045221900331,0.0076415865072137,7.5,0.75,1.152749999999999,0.115275,8.975795221900331,0.8729165865072135,11.207515565128835,1.060448431561052,0,1053.527880264717,153.70000000000002,14.975795221900332,6,2.1,3.8729165865072135,26.948711808407545,856876.837588159,1.691012186571954,45.6,47.4,387600,402900,Conditional\nPLT05,Epsilon Battery Recyclers,-4.0595,25.6776,5925,0,0,0.2,0,0.109894382229283,0,10.44416421514625,0,1.428,0.1428,11.982058597375532,0.1428,4.340828098056754,0,232.58897299655376,0,190.4,11.982058597375532,0,0.2,0.1428,12.324858597375533,1267852.972062573,2.5020571597825496,30.8,36.5,261800,310250,Conditional\nPLT06,Zeta Lead Processing,-4.9544,25.5726,5410,30,18,10,9,1.473773527557483,0,13.158353417352543,0.75,5.9167500000000015,0.59175,20.54887694491002,1.34175,53.15409856057332,0,408.15589317169673,3744.7340499351103,788.9000000000002,50.54887694491002,18,10,10.34175,88.89062694491002,953630.8569809616,1.8819523762421124,167.3,181.0,1422050,1538500,Excluded\nPLT07,Eta Metals Inc,-4.4719,25.1029,4439,8,0,10,7,0.335451154321872,0.2501865772485377,14.6615296981397,0,1.62525,0.162525,16.622230852461573,0.4127115772485377,9.927117826898622,29.61541910416689,423.86707106723065,0,216.7,24.622230852461573,0,10,7.4127115772485375,42.03494242971011,544531.624860469,1.0746113948005322,45.2,40.1,384200,340850,Conditional\nPLT08,Theta Environmental Services,-4.1076,25.8998,3339,22,18,10,3,0.752321134055558,0,7.865654802370185,0.75,4.050750000000001,0.4050749999999999,12.668725936425743,1.155075,16.746668444076736,0,16.278951801520638,2051.0972537682424,540.1000000000001,34.668725936425744,18,10,4.155075,66.82380093642574,506724.22374745447,1,66.8,44.6,567800,379100,Remediation\n","type":"text"}]
